---
title: "Weissman-replication-source-raw"
author: "Marton Kovacs"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

# Load packages
```{r load packages}
library(tidyverse)
library(janitor)
library(purrrlyr)
library(osfr)
```

# Load helper functions

```{r load helper functions}
source("utils.R")
```

# Download data from OSF
## OSF auth (until project is public)
osf_auth(token = read_lines("osf_token_write_martonbalazskovacs.txt"))
```{r osf authentication}
```

## Connect to data OSF folder
```{r osf connect to OSF folder}
data_guid <- "9knds"

weissman_project <- osf_retrieve_node(data_guid)
```

## Download data locally

```{r osf download data}
local_data_pth <- file.path("data","Source")

create_local_structure(local_data_pth)

data_files <- 
  weissman_project %>% 
  osf_ls_files() %>% 
  filter(name == "Source") %>% 
  osf_ls_files() 

data_files %>% 
  group_by(name) %>% # for each experiment type
  do(download_files(.,local_data_pth))

# uncomment following line to remove the data   
# remove_local_data(local_data_pth)
```

# Import and merge data

```{r}
## Function to save subdirectories and filename as a variable
read_plus <- function(pattern = ".csv$", path = "data/Source/", subfolder_name = subfolder_name, exclude = exclude) {
  list.files(path = paste0(path, subfolder_name), pattern = pattern, full.names = T, recursive = T) %>% 
    .[ !grepl(exclude, .) ] %>% 
    map_dfr(.,
        ~ read_csv(.x) %>% 
          mutate(data_type = str_extract(.x, "(?<=/).*?(?=/)"),
                 filename = str_remove_all(.x, ".*/|.csv"),
                 task = str_extract(.x, subfolder_name)))
}

# Saving subfolder names
subfolder <- list("primeprobe", "flanker", "stroop", "simon")

# Read in datafiles
source <-
  tibble(task = subfolder,
         response = map2(subfolder, "demographics.csv$",
                       ~ read_plus(subfolder_name = .x,
                                   exclude = .y)),
         demographics = map2(subfolder, "2019",
                       ~ read_plus(subfolder_name = .x,
                                  exclude = .y)))

# Read in participant identifiers data
participant_id <- read_csv("data/Source/participant-metadata.csv")
```

# Join demographics data with responses

```{r join demographic data}
source <- 
  source %>%
  mutate(demographics = map(demographics, ~ select(., -filename))) %>% 
  mutate(join = map2(response, demographics, ~ left_join(.x, .y, by = c("id", "task", "data_type"))))
```

# Join data with participant_id

```{r join participant id}
join_df <- function(df_nest, df_other) {
  left_join(df_nest, df_other, by = c("id", "task", "consentTime"))
}

source <- source %>%
  mutate(join_id = map(join, ~ join_df(., participant_id)))
```

# TODO: Add code to deidentify participants but make it possible to bind together different responses from the same participant.

# Save each task separately
## TODO: Write function for this task
```{r save tasks}
write_tsv(source$join_id[[1]], path = paste0("data/Raw/", source$task[[1]], "_data.tsv"))

write_tsv(source$join_id[[2]], path = paste0("data/Raw/", source$task[[2]], "_data.tsv"))

write_tsv(source$join_id[[3]], path = paste0("data/Raw/", source$task[[3]], "_data.tsv"))

write_tsv(source$join_id[[4]], path = paste0("data/Raw/", source$task[[4]], "_data.tsv"))
```
---
title: "Weissman-replication-source-raw"
author: "Marton Kovacs"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

# Load packages

```{r load packages}
library(tidyverse)
library(janitor)
library(osfr)
```

# Load helper functions

```{r load helper functions}
source("utils.R")
```

# Download data from OSF
## OSF auth (until project is public)
osf_auth(token = read_lines("osf_token_write_martonbalazskovacs.txt"))
```{r osf authentication}
```

## Connect to data OSF folder
```{r osf connect to OSF folder}
data_guid <- "9knds"

weissman_project <- osf_retrieve_node(data_guid)
```

## Download data locally

```{r osf download data}
local_data_pth <- file.path("data","Source")

create_local_structure(local_data_pth)

data_files <- 
  weissman_project %>% 
  osf_ls_files() %>% 
  filter(name == "Source") %>% 
  osf_ls_files() 

data_files %>% 
  group_by(name) %>% # for each experiment type
  do(download_files(.,local_data_pth))

# uncomment following line to remove the data   
# remove_local_data(local_data_pth)
```

# Import and merge data

```{r}
# Saving subfolder names
subfolder <- list("primeprobe", "flanker", "stroop", "simon")

# Read in datafiles
source <-
  tibble(task = subfolder,
         response = map(subfolder,
                       ~ read_plus(subfolder_name = .x,
                                   pattern = ".csv$",
                                   path = "data/Source/",
                                   exclude = "demographics.csv$",
                                   sep = ",")),
         demographics = map(subfolder,
                       ~ read_plus(subfolder_name = .x,
                                   pattern = ".csv$",
                                   path = "data/Source/",
                                   exclude = "2019",
                                   sep = ",")))

# Read in participant identifiers data
participant_id <- read_csv("data/Source/participant-metadata.csv")
```

# Join demographics data with responses

```{r join demographic data}
source <- 
  source %>%
  mutate(demographics = map(demographics, ~ select(., -filename))) %>% 
  mutate(join = map2(response, demographics, ~ left_join(.x, .y, by = c("id", "task", "data_type"))))
```

# Creating anonym id to link participants to responses

```{r}
participant_id <- 
  participant_id %>% 
  mutate(userId = if_else(userId == "abcdef12345",
                          paste0("abcdef12345", row_number()),
                          userId)) %>% 
  group_by(userId) %>% 
  mutate(participant_id = group_indices())
```

# Checking the number of participants for each task

```{r}
participant_id %>% 
  group_by(task) %>% 
  distinct(userId) %>% 
  count()
```

# Join data with participant_id

```{r join participant id}
source <- 
  source %>%
  mutate(join_id = map(join, ~ join_df(., participant_id)))
```

# Delete trial responses

```{r}
# UserIds to be deleted
trial_response_id <- c("1", "DELETE", "x")

# Deleting userId
source <-
  source %>% 
  mutate(filtered = map(join_id, ~ filter(., userId %ni% trial_response_id)))
```

# Delete cases where the userId is missing

```{r}
source <- 
  source %>% 
  mutate(filtered = map(filtered, ~ filter(., !is.na(userId))))
```

# Deidentify participatns

```{r}
source <- 
  source %>% 
  mutate(filtered = map(filtered, ~ select(., -userId, -debriefGeneralComments)))
```

# Create a variable to divide response from the first wave of data collection from the second wave in the Hungarian sample
```{r}
source <- 
  source %>% 
  mutate(filtered = map(filtered,
                    ~ mutate(.,
                             wave = case_when(loc == "HUN" & ymd("2019-05-07", tz = "Europe/Prague") > as_datetime(consentTime / 1000, tz = "Europe/Prague") ~ 1L,
                                              loc == "HUN" & ymd("2019-05-07", tz = "Europe/Prague") <= as_datetime(consentTime / 1000, tz = "Europe/Prague") ~ 2L,
                                              loc == "CZ" ~ 1L)
                             )
                    )
         )

```

# Keep only data from wave 1
```{r}
source <- 
  source %>% 
  mutate(filtered = map(filtered, ~ filter(., wave == 1L)))
```

# Save each task separately
## TODO: Write function for this task
```{r save tasks}
write_tsv(unnest(source$filtered[[1]]), path = paste0("data/Raw/", source$task[[1]], "/", source$task[[1]], "_data.tsv"))

write_tsv(unnest(source$filtered[[2]]), path = paste0("data/Raw/", source$task[[2]], "/", source$task[[2]], "_data.tsv"))

write_tsv(unnest(source$filtered[[3]]), path = paste0("data/Raw/", source$task[[3]], "/", source$task[[3]], "_data.tsv"))

write_tsv(unnest(source$filtered[[4]]), path = paste0("data/Raw/", source$task[[4]], "/", source$task[[4]], "_data.tsv"))
```